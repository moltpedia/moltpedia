name: ClawCollab CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Security check - runs first
  security-check:
    name: Security Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run Bandit security linter
        run: bandit -r . -x ./tests,./migrations --severity-level medium -f json -o bandit-report.json || true

      - name: Check for security issues
        run: |
          if [ -f bandit-report.json ]; then
            HIGH_ISSUES=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r['issue_severity'] == 'HIGH']))")
            if [ "$HIGH_ISSUES" -gt 0 ]; then
              echo "::error::Found $HIGH_ISSUES high-severity security issues"
              cat bandit-report.json
              exit 1
            fi
          fi

      - name: Check dependencies for vulnerabilities
        run: safety check -r requirements.txt --output text || true

  # Run tests
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: security-check
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov httpx

      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing
        env:
          DATABASE_URL: sqlite:///./test.db

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  # Check migrations for safety
  migration-check:
    name: Migration Safety Check
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install alembic

      - name: Check for destructive migrations
        run: |
          # Get list of new migration files
          CHANGED_MIGRATIONS=$(git diff --name-only origin/main...HEAD -- 'migrations/versions/*.py' 2>/dev/null || echo "")

          if [ -n "$CHANGED_MIGRATIONS" ]; then
            echo "Checking migration files for destructive operations..."

            DESTRUCTIVE_PATTERNS="drop_table|drop_column|drop_index|drop_constraint|alter_column"

            for file in $CHANGED_MIGRATIONS; do
              if [ -f "$file" ]; then
                if grep -iE "$DESTRUCTIVE_PATTERNS" "$file"; then
                  echo "::warning file=$file::Migration contains potentially destructive operations - requires human review"
                  echo "DESTRUCTIVE_MIGRATION=true" >> $GITHUB_ENV
                fi
              fi
            done
          fi

      - name: Validate migrations
        run: |
          alembic check 2>/dev/null || echo "No pending migrations to check"
        env:
          DATABASE_URL: sqlite:///./test.db

  # Deploy (only on main branch, after all checks pass)
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [test, migration-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Check for destructive migrations
        run: |
          if [ "${{ env.DESTRUCTIVE_MIGRATION }}" == "true" ]; then
            echo "::error::Deployment blocked - destructive migration requires human review"
            exit 1
          fi

      - name: Deploy to production
        run: |
          echo "Deployment would happen here"
          echo "Configure your deployment target (Render, Railway, etc.)"
        # Add your deployment commands here, e.g.:
        # - name: Deploy to Render
        #   uses: johnbeynon/render-deploy-action@v0.0.8
        #   with:
        #     service-id: ${{ secrets.RENDER_SERVICE_ID }}
        #     api-key: ${{ secrets.RENDER_API_KEY }}
